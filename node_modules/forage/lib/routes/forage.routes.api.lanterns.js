var APILanternsRoutes,
    Q           = require('q');

(function () {
    "use strict";
    
    // Setup a local variable for the Forage reference
    var Forage = null;
    
    APILanternsRoutes = function () {
        
        // Setup the JSON response variable that will contain our class
        var JSONResponse = null;
        
        // Setup the local variable upon loading the module
        this.initialize = function () {
            
            // Need to go 2 levels up since this is a sub-module of the HTTPServer
            Forage = module.parent.parent.exports;
            
            // Stand-alone JSON response class
            JSONResponse = require('../classes/forage.response');
            
        };
        
        this.listActive = function (request, response) {
            
            var games;

            // Create the response object
            response = new JSONResponse(request, response);
            
            if (!request.session.player) {
                response.errorResponse('Must be logged in', 832);
            } else if (!request.session.player.game) {
                response.errorResponse('Must join a game before searching for recipes', 833);
            } else {
                games = Forage.games.findById(request.session.player.game);
                games[0].listLanterns()
                    .then(function (activeLanterns) {
                        response.result = activeLanterns;
                        response.render();
                    }, console.log);

            }

        };
        
        /***!Retrieve specific game(s)
         *  GET /api/games/:_ids
         * @params  String:_ids     The requested ID(s)
         * @return  Array   An array of matching active games and their lanterns
         *
         * Note:    Games list method will likely change in the future to only
         *          show basic game details and not arrays of sub-objects.
         *          The full game data will only be return when joining a game.
         */
        this.getById = function (request, response) {
        
            // Create the response object
            response = new JSONResponse(request, response);
            
            if (request.session.player && request.session.player.game) {
            
                var games = Forage.games.findById(request.session.player.game);
                
                // Set the result to the array returned in the games model find method
                games[0].lanternsById(request.params._id)
                    .then(function (foundLanterns) {
                            response.result = foundLanterns;
                            response.render();
                        }, console.log);
            } else {
                response.errorResponse('Must join a game before searching for lanterns', 833);
            }
        };
        
        this.capture = function (request, response) {
            
            response = new JSONResponse(request, response);
            
            var games = Forage.games.findById(request.session.player.game);
            
            games[0].lanternsById(request.params._id)
                .then(function (lanterns) { 
                    if (lanterns) {
                        if (lanterns[0].status === 1) {
                            if (games[0].updateLanternStatus(request.params._id, 0, request.session.player._id)) {
                                response.result = 20000;
                                response.render();
                            } else {
                                response.errorResponse('No lantern with that ID', 901);
                            }
                        } else {
                            response.errorResponse('Lantern already in use', 700);
                        }
                    } else {
                        response.errorResponse('No lantern with that ID', 901);
                    }
                }, console.log);
            
        };
        
        this.release = function (request, response) {
            
            response = new JSONResponse(request, response);
            
            var games = Forage.games.findById(request.session.player.game);
            
            games[0].lanternsById(request.params._id)
                .then(function (lanterns) { 
                    if (lanterns) {
                        if (lanterns[0].occupant === request.session.player._id || request.session.player.is_admin) {
                            var lantern = games[0].updateLanternStatus(request.params._id, 1)
                            if (lantern) {
                                response.result = lantern;
                                response.render();
                            } else {
                                response.errorResponse('No lantern with that ID', 901);
                            }
                        } else {
                            response.errorRespont('You are not the occupant of requested lantern.', 701);
                        }
                    } else {
                        response.errorResponse('No lantern with that ID', 901);
                    }
                }, console.log);
        };
        
        this.initialize();
        
    };
    
    APILanternsRoutes = new APILanternsRoutes();
    
}());

module.exports = APILanternsRoutes;